<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>L5-L6 è‹±èªå£èªªæŒ‘æˆ°ç«™ - æ™ºæ…§è¨ˆåˆ†ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;600&display=swap');
        
        /* é˜²äº‚é»é¸å–æ©Ÿåˆ¶ */
        * {
            -webkit-user-select: none;  /* Safari/Chrome */
            -moz-user-select: none;     /* Firefox */
            -ms-user-select: none;      /* IE */
            user-select: none;          /* Standard */
            -webkit-touch-callout: none; /* é˜²æ­¢ iOS å½ˆå‡ºé¸å–® */
            -webkit-tap-highlight-color: transparent; /* å»é™¤é»æ“Šè—æ¡† */
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .key-btn {
            background-color: #f1f5f9;
            border-radius: 16px;
            padding: 16px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #334155;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .key-btn:active { background-color: #cbd5e1; transform: scale(0.9); }

        .unit-tab-active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .modal-overlay { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- ç™»å…¥èˆ‡æ•¸å­—éµç›¤ -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">ğŸ—£ï¸ æ®µè€ƒå£èªªæŒ‘æˆ°ç«™</h2>
            <p class="text-slate-500 mb-4">è«‹è¼¸å…¥åº§è™Ÿé–‹å§‹æŒ‘æˆ°</p>
            <div id="id-display" class="w-full bg-slate-100 border-2 border-slate-200 rounded-2xl px-4 py-3 mb-6 text-center text-4xl font-bold text-indigo-600 h-16 flex items-center justify-center italic"></div>
            <div class="grid grid-cols-3 gap-3 mb-6">
                <button onclick="pressKey('1')" class="key-btn">1</button>
                <button onclick="pressKey('2')" class="key-btn">2</button>
                <button onclick="pressKey('3')" class="key-btn">3</button>
                <button onclick="pressKey('4')" class="key-btn">4</button>
                <button onclick="pressKey('5')" class="key-btn">5</button>
                <button onclick="pressKey('6')" class="key-btn">6</button>
                <button onclick="pressKey('7')" class="key-btn">7</button>
                <button onclick="pressKey('8')" class="key-btn">8</button>
                <button onclick="pressKey('9')" class="key-btn">9</button>
                <button onclick="pressKey('clear')" class="key-btn text-red-500 text-sm">æ¸…é™¤</button>
                <button onclick="pressKey('0')" class="key-btn">0</button>
                <button onclick="pressKey('back')" class="key-btn text-orange-500">âŒ«</button>
            </div>
            <p id="login-error" class="text-red-500 text-sm mb-4 hidden font-bold">æŸ¥ç„¡æ­¤äººï¼Œè«‹é‡æ–°æª¢æŸ¥åº§è™Ÿ</p>
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl text-lg shadow-lg active:scale-95 transition-transform">ç™»å…¥é—–é—œ</button>
            <button onclick="toggleFullScreen()" class="mt-4 text-slate-400 text-xs underline">ğŸ–¥ï¸ å…¨è¢å¹•æ¨¡å¼</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div id="leaderboard-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800 italic">ğŸ† æ®µè€ƒç©åˆ†æ¦œ</h2>
                <button onclick="toggleLeaderboard(false)" class="text-slate-400 text-3xl font-light">&times;</button>
            </div>
            <div id="leaderboard-list" class="overflow-y-auto flex-1 space-y-2"></div>
        </div>
    </div>

    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-start mb-6 pt-4">
            <div>
                <h1 class="text-xl font-bold text-slate-800">æ®µè€ƒè¤‡ç¿’ç«™</h1>
                <div class="flex items-center text-indigo-600 font-bold">
                    <span id="display-student-id"></span>
                    <span id="display-student-name" class="ml-2"></span>
                </div>
                <p class="text-slate-600 text-sm">ç›®å‰çš„ç¸½ç©åˆ†: <span id="display-score" class="text-green-600 font-bold">0</span></p>
            </div>
            <div class="flex space-x-2">
                <button onclick="toggleLeaderboard(true)" class="bg-white p-3 rounded-2xl shadow-sm text-2xl">ğŸ†</button>
                <button onclick="logout()" class="bg-slate-50 p-2 rounded-2xl text-slate-400 flex flex-col items-center border border-slate-100">
                    <span class="text-[10px] font-bold">æ›äººæŒ‘æˆ°</span>
                    <span class="text-xs">LOGOUT</span>
                </button>
            </div>
        </header>

        <div class="flex p-1 bg-slate-200 rounded-2xl mb-4">
            <button onclick="switchLesson(5)" id="tab-l5" class="flex-1 py-2 rounded-xl font-bold transition-all text-slate-600">Lesson 5</button>
            <button onclick="switchLesson(6)" id="tab-l6" class="flex-1 py-2 rounded-xl font-bold transition-all unit-tab-active">Lesson 6</button>
        </div>

        <div class="flex space-x-2 mb-6" id="part-tabs">
            <button onclick="switchPart(1)" id="btn-part1" class="flex-1 py-2 rounded-xl font-bold bg-indigo-600 text-white">Part 1</button>
            <button onclick="switchPart(2)" id="btn-part2" class="flex-1 py-2 rounded-xl font-bold bg-white text-slate-600">Part 2</button>
            <button onclick="switchPart(3)" id="btn-part3" class="flex-1 py-2 rounded-xl font-bold bg-white text-slate-600">Part 3</button>
        </div>

        <div id="content-area" class="space-y-4 pb-20"></div>

        <div id="feedback-toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-sm p-5 rounded-3xl hidden shadow-2xl text-center z-[100] transform transition-all">
            <p id="feedback-text" class="text-xl font-bold"></p>
            <div id="word-comparison" class="text-sm mt-2 flex flex-wrap justify-center gap-1"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (è«‹ç¢ºä¿é€™æ˜¯æ‚¨æ­£ç¢ºçš„ Key) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAGbLoc6EJLktGW62RISkajBh8Req6a0iY",
            authDomain: "speaking-station-e916e.firebaseapp.com",
            projectId: "speaking-station-e916e",
            storageBucket: "speaking-station-e916e.firebasestorage.app",
            messagingSenderId: "727220421214",
            appId: "1:727220421214:web:68ad57a589118995c3eacf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'speaking-exam-final-v2';

        const studentList = {
            "1": "ä½•æ‰¿è«º", "2": "æ—å®£å»·", "3": "æŸ¯æ·¯ç››", "4": "æ´ªçš“ç‘‹", "5": "é™³æ°¸ç¿°",
            "6": "é™³ç«‹éˆ", "7": "é™³å¥•è±ª", "8": "é™³å˜‰ä½‘", "9": "åŠ‰æ‰¿ç‘‹", "10": "é„­è«ºéš†",
            "11": "é­å®å®‡", "12": "é­æ™Ÿç¥", "13": "é­è© å“²", "14": "ä½•æ„æ¶µ", "15": "æé£›æœˆ",
            "16": "æ—ä»¥æ¬£", "17": "æ—æ•¬èŠ", "18": "æŸ¯ä½³å¦¤", "19": "é™³å¹¼åº­", "20": "é»ƒç¿Šç¦",
            "21": "é»ƒé¦¨è±", "22": "åŠ‰åº­ç‘‹", "23": "ç°¡é‚¡ä¼ƒ", "99": "è€å¸«"
        };

        let currentUser = null, studentId = "", currentScore = 0;
        let masteredMap = {}; // æ”¹ç”¨ç‰©ä»¶å„²å­˜æ¯é¡Œåˆ†æ•¸ { "l5-p1-1": 10 }
        let currentLesson = 6, currentPart = 1, isRecording = false;

        const sentencesData = {
            5: {
                1: [
                    { id: "l5-p1-1", en: "What are you doing?", zh: "ä½ æ­£åœ¨åšä»€éº¼ï¼Ÿ" },
                    { id: "l5-p1-2", en: "I'm writing a letter to my new friend.", zh: "æˆ‘æ­£åœ¨å¯«ä¿¡çµ¦æˆ‘çš„æ–°æœ‹å‹ã€‚" },
                    { id: "l5-p1-3", en: "Are you preparing for the English class?", zh: "ä½ æ­£åœ¨ç‚ºè‹±æ–‡èª²åšæº–å‚™å—ï¼Ÿ" }
                ],
                2: [
                    { id: "l5-p2-1", en: "Wait. What day is it today?", zh: "ç­‰ç­‰ï¼Œä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ï¼Ÿ" },
                    { id: "l5-p2-2", en: "Is the game on Thursday?", zh: "æ¯”è³½æ˜¯åœ¨æ˜ŸæœŸå››å—ï¼Ÿ" },
                    { id: "l5-p2-3", en: "What time is the basketball game?", zh: "ç±ƒçƒæ¯”è³½æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ" },
                    { id: "l5-p2-4", en: "It's at ten thirty on Sunday.", zh: "æ˜¯åœ¨é€±æ—¥ä¸Šåˆåé»åŠã€‚" }
                ],
                3: [
                    { id: "l5-p3-1", en: "Everyone is doing something different.", zh: "æ¯å€‹äººéƒ½åœ¨åšä¸åŒçš„äº‹æƒ…ã€‚" },
                    { id: "l5-p3-2", en: "He is thinking about the basketball game.", zh: "ä»–æ­£åœ¨æƒ³è‘—é‚£å ´ç±ƒçƒè³½ã€‚" },
                    { id: "l5-p3-3", en: "I'm thinking about you all the time.", zh: "æˆ‘ä¸€ç›´éƒ½åœ¨æƒ³å¿µè‘—ä½ ã€‚" }
                ]
            },
            6: {
                1: [
                    { id: "l6-p1-1", en: "Are there any shelves outside the door?", zh: "é–€å£å¤–é¢æœ‰ä»»ä½•æ¶å­å—ï¼Ÿ" },
                    { id: "l6-p1-2", en: "Is there a library in the building?", zh: "é€™æ£Ÿå»ºç¯‰ç‰©è£¡æœ‰åœ–æ›¸é¤¨å—ï¼Ÿ" },
                    { id: "l6-p1-3", en: "No, there aren't any trees.", zh: "ä¸ï¼Œé‚£è£¡æ²’æœ‰ä»»ä½•æ¨¹ã€‚" }
                ],
                2: [
                    { id: "l6-p2-1", en: "I can show you around the school.", zh: "æˆ‘å¯ä»¥å¸¶ä½ åƒè§€å­¸æ ¡ã€‚" },
                    { id: "l6-p2-2", en: "There are large cafeterias in South Korean schools.", zh: "å—éŸ“çš„å­¸æ ¡è£¡æœ‰å¤§å‹çš„è‡ªåŠ©é¤å»³ã€‚" },
                    { id: "l6-p2-3", en: "I can work out in the gym after school.", zh: "æˆ‘æ”¾å­¸å¾Œå¯ä»¥åœ¨é«”è‚²é¤¨å¥èº«ã€‚" }
                ],
                3: [
                    { id: "l6-p3-1", en: "It's in the warming cabinet.", zh: "å®ƒåœ¨è’¸é£¯ç®±è£¡ã€‚" },
                    { id: "l6-p3-2", en: "There are a lot of different things in Taiwan.", zh: "å°ç£æœ‰å¾ˆå¤šä¸åŒçš„äº‹ç‰©ã€‚" },
                    { id: "l6-p3-3", en: "I'm still finding my feet.", zh: "æˆ‘é‚„åœ¨é©æ‡‰æ–°ç’°å¢ƒã€‚" },
                    { id: "l6-p3-4", en: "Everyone at school is really nice to me.", zh: "å­¸æ ¡çš„æ¯å€‹äººå°æˆ‘éƒ½å¾ˆå¥½ã€‚" }
                ]
            }
        };

        // --- æ•¸å­—éµç›¤ ---
        let inputId = "";
        window.pressKey = (key) => {
            const display = document.getElementById('id-display');
            if (key === 'back') inputId = inputId.slice(0, -1);
            else if (key === 'clear') inputId = "";
            else if (inputId.length < 2) inputId += key;
            display.innerText = inputId;
        };

        // --- ç™»å…¥èˆ‡è³‡æ–™ ---
        async function login() {
            const id = parseInt(inputId, 10).toString();
            if (!studentList[id]) { document.getElementById('login-error').classList.remove('hidden'); return; }
            studentId = id;
            document.getElementById('display-student-id').innerText = "åº§è™Ÿ: " + studentId;
            document.getElementById('display-student-name').innerText = studentList[id];
            
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', studentId);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                masteredMap = data.masteredMap || {};
                currentScore = Object.values(masteredMap).reduce((a, b) => a + b, 0);
            } else {
                masteredMap = {}; currentScore = 0;
                await setDoc(userRef, { studentId, studentName: studentList[id], score: 0, masteredMap: {}, updatedAt: Date.now() });
            }
            updateTotalScoreUI();
            document.getElementById('login-modal').classList.add('hidden');
            renderSentences();
        }

        function updateTotalScoreUI() {
            currentScore = Object.values(masteredMap).reduce((a, b) => a + (b || 0), 0);
            document.getElementById('display-score').innerText = currentScore;
        }

        window.logout = () => { location.reload(); };

        // --- å£èªªæ ¸å¿ƒé‚è¼¯ ---
        function clean(s) { return s.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g,"").split(/\s+/).filter(x => x.length > 0); }

        window.handleStartSpeaking = (id, targetText, btn) => {
            if (isRecording) return;
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRec) return alert("ä¸æ”¯æ´èªéŸ³");
            const recognition = new SpeechRec();
            recognition.lang = 'en-US';
            isRecording = true;
            btn.innerHTML = '<span class="recording-pulse">ğŸ”´ è†è½ä¸­...</span>';
            btn.classList.add('bg-red-500', 'text-white');

            recognition.start();
            recognition.onresult = async (e) => {
                const saidText = e.results[0][0].transcript;
                const targetWords = clean(targetText);
                const saidWords = clean(saidText);
                
                // è¨ˆç®—å°äº†å¹¾å€‹å–®å­—
                let correctCount = 0;
                const comparisonDiv = document.getElementById('word-comparison');
                comparisonDiv.innerHTML = "";

                targetWords.forEach(tw => {
                    const span = document.createElement('span');
                    span.innerText = tw;
                    if (saidWords.includes(tw)) {
                        correctCount++;
                        span.className = "text-green-300 font-bold";
                    } else {
                        span.className = "text-red-200 line-through opacity-70";
                    }
                    comparisonDiv.appendChild(span);
                });

                const accuracy = correctCount / targetWords.length;
                const scoreThisTime = Math.round(accuracy * 10); // ä¸€é¡Œæ»¿åˆ† 10 åˆ†
                
                // åªæœ‰æ›´é«˜åˆ†æ‰æ›´æ–°è³‡æ–™åº«
                const previousBest = masteredMap[id] || 0;
                if (scoreThisTime > previousBest) {
                    masteredMap[id] = scoreThisTime;
                    updateTotalScoreUI();
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', studentId), {
                        score: currentScore,
                        masteredMap: masteredMap,
                        updatedAt: Date.now()
                    }, { merge: true });
                }

                showFeedback(accuracy >= 0.5 ? `Good Job! +${scoreThisTime}` : `Keep trying! +${scoreThisTime}`, accuracy >= 0.5 ? "success" : "fail");
                renderSentences();
            };
            recognition.onend = () => { isRecording = false; renderSentences(); };
        };

        // --- UI æ¸²æŸ“ ---
        window.switchLesson = (lesson) => { currentLesson = lesson; currentPart = 1; renderTabs(); renderSentences(); };
        window.switchPart = (part) => { currentPart = part; renderTabs(); renderSentences(); };

        function renderTabs() {
            document.getElementById('tab-l5').className = currentLesson === 5 ? "flex-1 py-2 rounded-xl font-bold unit-tab-active" : "flex-1 py-2 rounded-xl font-bold text-slate-600";
            document.getElementById('tab-l6').className = currentLesson === 6 ? "flex-1 py-2 rounded-xl font-bold unit-tab-active" : "flex-1 py-2 rounded-xl font-bold text-slate-600";
            [1,2,3].forEach(p => {
                document.getElementById(`btn-part${p}`).className = currentPart === p ? "flex-1 py-2 rounded-xl font-bold bg-indigo-600 text-white" : "flex-1 py-2 rounded-xl font-bold bg-white text-slate-600";
            });
        }

        function renderSentences() {
            const container = document.getElementById('content-area');
            container.innerHTML = '';
            const list = sentencesData[currentLesson][currentPart] || [];
            list.forEach(item => {
                const score = masteredMap[item.id] || 0;
                const card = document.createElement('div');
                card.className = `glass-card p-5 border-2 transition-all ${score >= 5 ? 'border-green-200 bg-green-50/50' : 'border-transparent'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="text-lg font-bold text-slate-800">${item.en}</p>
                            <p class="text-xs text-slate-400 font-bold">${item.zh}</p>
                        </div>
                        <div class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-black">
                            Best: ${score}/10
                        </div>
                    </div>
                    <button onclick="handleStartSpeaking('${item.id}', '${item.en.replace(/'/g, "\\'")}', this)" 
                            class="w-full ${score >= 5 ? 'bg-green-500' : 'bg-indigo-600'} text-white py-3 rounded-2xl font-bold shadow-md active:scale-95 transition-all">
                        ğŸ¤ ${score > 0 ? 'å†æ¬¡æŒ‘æˆ° (Challenge Again)' : 'é–‹å§‹å£èªª'}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function setupLeaderboardListener() {
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard')), (snap) => {
                const players = []; snap.forEach(d => players.push(d.data()));
                players.sort((a,b) => b.score - a.score || parseInt(a.studentId) - parseInt(b.studentId));
                document.getElementById('leaderboard-list').innerHTML = players.map((p,i) => `
                    <div class="flex items-center justify-between p-3 rounded-2xl ${p.studentId === studentId ? 'bg-indigo-600 text-white' : 'bg-slate-50'}">
                        <span class="font-bold w-8 text-center text-xs opacity-50">${i+1}</span>
                        <div class="flex-1 flex flex-col ml-2">
                            <span class="text-xs opacity-70">åº§è™Ÿ ${p.studentId}</span>
                            <span class="font-bold">${p.studentName}</span>
                        </div>
                        <span class="font-black text-lg">${p.score}</span>
                    </div>`).join('');
            });
        }

        function showFeedback(msg, type) {
            const toast = document.getElementById('feedback-toast');
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-sm p-5 rounded-3xl shadow-2xl text-center z-[100] ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-500 text-white'}`;
            document.getElementById('feedback-text').innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function playSuccessSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(523, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1046, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.05);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
            osc.start(); osc.stop(ctx.currentTime + 0.3);
        }

        window.toggleLeaderboard = (show) => document.getElementById('leaderboard-modal').classList.toggle('hidden', !show);
        window.toggleFullScreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };

        // ç¦æ­¢åœ¨ç™»å…¥æŒ‰éˆ•å‰æ“ä½œ
        signInAnonymously(auth).then(user => {
            currentUser = user;
            document.getElementById('login-btn').innerText = "é€£ç·šæˆåŠŸï¼Œè«‹ç™»å…¥";
            document.getElementById('login-btn').onclick = login;
        });
    </script>
</body>
</html>
