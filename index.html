<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>L5-L6 è‹±èªå£èªªæŒ‘æˆ°ç«™ - æœ€çµ‚éƒ¨ç½²ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;600&display=swap');
        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-overlay { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .unit-tab-active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        input { font-size: 16px !important; }
        
        #connection-error-banner {
            display: none;
            background-color: #ef4444;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="connection-error-banner">
        âš ï¸ é›²ç«¯é€£ç·šå¤±æ•—ï¼šè«‹ç¢ºèªå·²æ›¿æ› Firebase Config ä¸”ç¶²è·¯æœªå°é– Google æœå‹™ã€‚
    </div>

    <!-- ç™»å…¥è¦–çª— -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">ğŸ—£ï¸ æ®µè€ƒå£èªªæŒ‘æˆ°ç«™</h2>
            <p class="text-slate-500 mb-6">è«‹è¼¸å…¥åº§è™Ÿé–‹å§‹è¤‡ç¿’ L5-L6</p>
            <input type="number" id="student-id-input" pattern="\d*" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š05" 
                   class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 mb-2 text-center text-xl focus:border-indigo-500 outline-none">
            <p id="login-error" class="text-red-500 text-sm mb-4 hidden font-bold">æŸ¥ç„¡æ­¤äººï¼Œè«‹é‡æ–°è¼¸å…¥</p>
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all text-lg mb-3">
                ç™»å…¥ç³»çµ±
            </button>
            <button onclick="toggleFullScreen()" class="text-slate-400 text-xs hover:underline">ğŸ–¥ï¸ åˆ‡æ›å…¨è¢å¹•æ¨¡å¼</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œè¦–çª— -->
    <div id="leaderboard-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ† æ®µè€ƒç©åˆ†æ¦œ</h2>
                <button onclick="toggleLeaderboard(false)" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            <div id="leaderboard-list" class="overflow-y-auto flex-1 space-y-3 pr-2"></div>
        </div>
    </div>

    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-xl font-bold text-slate-800">æ®µè€ƒè¤‡ç¿’ç«™</h1>
                <p class="text-slate-600 text-sm">åº§è™Ÿ: <span id="display-student-id" class="font-bold text-indigo-600">-</span> <span id="display-student-name" class="ml-1 text-slate-500"></span></p>
                <p class="text-slate-600 text-sm">ç¸½åˆ†: <span id="display-score" class="font-bold text-green-600">0</span></p>
            </div>
            <button onclick="toggleLeaderboard(true)" class="bg-white p-3 rounded-2xl shadow-sm hover:shadow-md transition-all text-2xl">ğŸ†</button>
        </header>

        <div class="flex p-1 bg-slate-200 rounded-2xl mb-6">
            <button onclick="switchLesson(5)" id="tab-l5" class="flex-1 py-2 rounded-xl font-bold transition-all text-slate-600">Lesson 5</button>
            <button onclick="switchLesson(6)" id="tab-l6" class="flex-1 py-2 rounded-xl font-bold transition-all unit-tab-active">Lesson 6</button>
        </div>

        <div class="flex space-x-2 mb-6" id="part-tabs">
            <button onclick="switchPart(1)" id="btn-part1" class="flex-1 py-3 rounded-xl font-bold transition-all bg-indigo-600 text-white shadow-lg">Part 1</button>
            <button onclick="switchPart(2)" id="btn-part2" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white text-slate-600">Part 2</button>
            <button onclick="switchPart(3)" id="btn-part3" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white text-slate-600">Part 3</button>
        </div>

        <div id="content-area" class="space-y-4 pb-12"></div>

        <div id="feedback-toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-sm p-5 rounded-3xl hidden shadow-2xl text-center z-[100] transform transition-all">
            <p id="feedback-text" class="text-xl font-bold"></p>
            <p id="transcript-text" class="text-sm opacity-90 mt-1"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ‚¨æä¾›çš„ Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAGbLoc6EJLktGW62RISkajBh8Req6a0iY",
            authDomain: "speaking-station-e916e.firebaseapp.com",
            projectId: "speaking-station-e916e",
            storageBucket: "speaking-station-e916e.firebasestorage.app",
            messagingSenderId: "727220421214",
            appId: "1:727220421214:web:68ad57a589118995c3eacf"
        };

        const isPlaceholder = firebaseConfig.apiKey.includes("è²¼ä¸Šæ‚¨çš„");
        let app, auth, db;
        const appId = 'speaking-exam-final-v1';

        const studentList = {
            "1": "ä½•æ‰¿è«º", "2": "æ—å®£å»·", "3": "æŸ¯æ·¯ç››", "4": "æ´ªçš“ç‘‹", "5": "é™³æ°¸ç¿°",
            "6": "é™³ç«‹éˆ", "7": "é™³å¥•è±ª", "8": "é™³å˜‰ä½‘", "9": "åŠ‰æ‰¿ç‘‹", "10": "é„­è«ºéš†",
            "11": "é­å®å®‡", "12": "é­æ™Ÿç¥", "13": "é­è© å“²", "14": "ä½•æ„æ¶µ", "15": "æé£›æœˆ",
            "16": "æ—ä»¥æ¬£", "17": "æ—æ•¬èŠ", "18": "æŸ¯ä½³å¦¤", "19": "é™³å¹¼åº­", "20": "é»ƒç¿Šç¦",
            "21": "é»ƒé¦¨è±", "22": "åŠ‰åº­ç‘‹", "23": "ç°¡é‚¡ä¼ƒ", "99": "è€å¸«"
        };

        let currentUser = null;
        let studentId = "";
        let currentScore = 0;
        let masteredSentences = [];
        let currentLesson = 6;
        let currentPart = 1;
        let isRecording = false;

        const sentencesData = {
            5: {
                1: [
                    { id: "l5-p1-1", en: "What are you doing?", zh: "ä½ æ­£åœ¨åšä»€éº¼ï¼Ÿ" },
                    { id: "l5-p1-2", en: "I'm writing a letter to my new friend.", zh: "æˆ‘æ­£åœ¨å¯«ä¿¡çµ¦æˆ‘çš„æ–°æœ‹å‹ã€‚" },
                    { id: "l5-p1-3", en: "Are you preparing for the English class?", zh: "ä½ æ­£åœ¨ç‚ºè‹±æ–‡èª²åšæº–å‚™å—ï¼Ÿ" }
                ],
                2: [
                    { id: "l5-p2-1", en: "Wait. What day is it today?", zh: "ç­‰ç­‰ï¼Œä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ï¼Ÿ" },
                    { id: "l5-p2-2", en: "Is the game on Thursday?", zh: "æ¯”è³½æ˜¯åœ¨æ˜ŸæœŸå››å—ï¼Ÿ" },
                    { id: "l5-p2-3", en: "What time is the basketball game?", zh: "ç±ƒçƒæ¯”è³½æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ" },
                    { id: "l5-p2-4", en: "It's at ten thirty on Sunday.", zh: "æ˜¯åœ¨é€±æ—¥ä¸Šåˆåé»åŠã€‚" }
                ],
                3: [
                    { id: "l5-p3-1", en: "Everyone is doing something different.", zh: "æ¯å€‹äººéƒ½åœ¨åšä¸åŒçš„äº‹æƒ…ã€‚" },
                    { id: "l5-p3-2", en: "He is thinking about the basketball game.", zh: "ä»–æ­£åœ¨æƒ³è‘—é‚£å ´ç±ƒçƒè³½ã€‚" },
                    { id: "l5-p3-3", en: "I'm thinking about you all the time.", zh: "æˆ‘ä¸€ç›´éƒ½åœ¨æƒ³å¿µè‘—ä½ ã€‚" }
                ]
            },
            6: {
                1: [
                    { id: "l6-p1-1", en: "Are there any shelves outside the door?", zh: "é–€å£å¤–é¢æœ‰ä»»ä½•æ¶å­å—ï¼Ÿ" },
                    { id: "l6-p1-2", en: "Is there a library in the building?", zh: "é€™æ£Ÿå»ºç¯‰ç‰©è£¡æœ‰åœ–æ›¸é¤¨å—ï¼Ÿ" },
                    { id: "l6-p1-3", en: "No, there aren't any trees.", zh: "ä¸ï¼Œé‚£è£¡æ²’æœ‰ä»»ä½•æ¨¹ã€‚" }
                ],
                2: [
                    { id: "l6-p2-1", en: "I can show you around the school.", zh: "æˆ‘å¯ä»¥å¸¶ä½ åƒè§€å­¸æ ¡ã€‚" },
                    { id: "l6-p2-2", en: "There are large cafeterias in South Korean schools.", zh: "å—éŸ“çš„å­¸æ ¡è£¡æœ‰å¤§å‹çš„è‡ªåŠ©é¤å»³ã€‚" },
                    { id: "l6-p2-3", en: "I can work out in the gym after school.", zh: "æˆ‘æ”¾å­¸å¾Œå¯ä»¥åœ¨é«”è‚²é¤¨å¥èº«ã€‚" }
                ],
                3: [
                    { id: "l6-p3-1", en: "It's in the warming cabinet.", zh: "å®ƒåœ¨è’¸é£¯ç®±è£¡ã€‚" },
                    { id: "l6-p3-2", en: "There are a lot of different things in Taiwan.", zh: "å°ç£æœ‰å¾ˆå¤šä¸åŒçš„äº‹ç‰©ã€‚" },
                    { id: "l6-p3-3", en: "I'm still finding my feet.", zh: "æˆ‘é‚„åœ¨é©æ‡‰æ–°ç’°å¢ƒã€‚" },
                    { id: "l6-p3-4", en: "Everyone at school is really nice to me.", zh: "å­¸æ ¡çš„æ¯å€‹äººå°æˆ‘éƒ½å¾ˆå¥½ã€‚" }
                ]
            }
        };

        async function signInWithRetry(retries = 5) {
            if (isPlaceholder) return null;
            for (let i = 0; i < retries; i++) {
                try { return await signInAnonymously(auth); } catch (err) {
                    if (i === retries - 1) throw err;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        async function init() {
            if (isPlaceholder) {
                document.getElementById('connection-error-banner').style.display = 'block';
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInWithRetry();
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('login-btn').onclick = login;
                        setupLeaderboardListener();
                    }
                });
            } catch (err) {
                document.getElementById('connection-error-banner').style.display = 'block';
            }
        }

        async function login() {
            if (!currentUser) return;
            const input = document.getElementById('student-id-input').value;
            const id = parseInt(input, 10).toString();
            if (!studentList[id]) { document.getElementById('login-error').classList.remove('hidden'); return; }
            document.getElementById('login-error').classList.add('hidden');
            studentId = id;
            document.getElementById('display-student-id').innerText = studentId;
            document.getElementById('display-student-name').innerText = studentList[id];
            
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', studentId);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                currentScore = userDoc.data().score || 0;
                masteredSentences = userDoc.data().mastered || [];
            } else {
                await setDoc(userRef, { studentId, studentName: studentList[id], score: 0, mastered: [], updatedAt: Date.now() });
            }
            document.getElementById('display-score').innerText = currentScore;
            document.getElementById('login-modal').classList.add('hidden');
            renderSentences();
        }

        window.toggleFullScreen = () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(() => {}); }
            else { document.exitFullscreen(); }
        };

        window.switchLesson = (lesson) => {
            currentLesson = lesson; currentPart = 1;
            document.getElementById('tab-l5').className = lesson === 5 ? "flex-1 py-2 rounded-xl font-bold transition-all unit-tab-active" : "flex-1 py-2 rounded-xl font-bold transition-all text-slate-600";
            document.getElementById('tab-l6').className = lesson === 6 ? "flex-1 py-2 rounded-xl font-bold transition-all unit-tab-active" : "flex-1 py-2 rounded-xl font-bold transition-all text-slate-600";
            switchPart(1);
        };

        window.switchPart = (part) => {
            currentPart = part;
            [1, 2, 3].forEach(p => {
                const btn = document.getElementById(`btn-part${p}`);
                btn.className = (p === part) ? "flex-1 py-3 rounded-xl font-bold transition-all bg-indigo-600 text-white shadow-lg" : "flex-1 py-3 rounded-xl font-bold transition-all bg-white text-slate-600";
            });
            renderSentences();
        };

        function renderSentences() {
            const container = document.getElementById('content-area');
            container.innerHTML = '';
            const currentSet = sentencesData[currentLesson][currentPart] || [];
            currentSet.forEach((item) => {
                const isDone = masteredSentences.includes(item.id);
                const card = document.createElement('div');
                card.className = `glass-card p-5 border-2 transition-all ${isDone ? 'border-green-200 bg-green-50' : 'border-transparent'}`;
                card.innerHTML = `
                    <div class="mb-3">
                        <p class="text-lg font-semibold text-slate-800 leading-tight">${item.en}</p>
                        <p class="text-sm text-slate-500 mt-1">${item.zh}</p>
                    </div>
                    <button onclick="handleStartSpeaking('${item.id}', '${item.en.replace(/'/g, "\\'")}', this)" 
                            class="w-full ${isDone ? 'bg-green-500 text-white shadow-md' : 'bg-indigo-50 text-indigo-600'} py-3 rounded-xl font-bold flex items-center justify-center space-x-2 transition-all">
                        <span>${isDone ? 'âœ… å·²å®Œæˆ' : 'ğŸ¤ é–‹å§‹ç·´ç¿’'}</span>
                    </button>`;
                container.appendChild(card);
            });
        }

        window.handleStartSpeaking = (id, targetText, btn) => {
            if (isRecording) return;
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = SpeechRec ? new SpeechRec() : null;
            if (!recognition) return alert("ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
            isRecording = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="recording-pulse">ğŸ”´ æ­£åœ¨è†è½...</span>';
            btn.classList.add('bg-red-500', 'text-white');
            recognition.lang = 'en-US';
            recognition.start();
            recognition.onresult = async (e) => {
                const said = e.results[0][0].transcript;
                const clean = (s) => s.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g,"").trim();
                if (clean(said) === clean(targetText)) {
                    playSuccessSound();
                    if (!masteredSentences.includes(id)) {
                        masteredSentences.push(id);
                        currentScore += 10;
                        document.getElementById('display-score').innerText = currentScore;
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', studentId), {
                            score: currentScore, mastered: masteredSentences, studentName: studentList[studentId], updatedAt: Date.now()
                        }, { merge: true });
                    }
                    renderSentences();
                    showFeedback("Good Job! ğŸ‰", "success", `ä½ èªªçš„æ˜¯: "${said}"`);
                } else { showFeedback("Try again!", "fail", `ä½ èªªçš„æ˜¯: "${said}"`); }
            };
            recognition.onend = () => { btn.innerHTML = originalHTML; btn.classList.remove('bg-red-500'); isRecording = false; };
        };

        function setupLeaderboardListener() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
            onSnapshot(q, (snapshot) => {
                const players = [];
                snapshot.forEach(doc => players.push(doc.data()));
                players.sort((a, b) => b.score - a.score || parseInt(a.studentId) - parseInt(b.studentId));
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = players.map((p, i) => `
                    <div class="flex items-center justify-between p-4 rounded-2xl ${p.studentId === studentId ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-50 text-slate-700'}">
                        <div class="flex items-center space-x-4">
                            <span class="font-bold opacity-60 w-6">${i + 1}.</span>
                            <div class="flex flex-col">
                                <span class="font-bold text-xs">åº§è™Ÿ ${p.studentId}</span>
                                <span class="font-bold">${p.studentName || 'å­¸ç”Ÿ'}</span>
                            </div>
                        </div>
                        <span class="font-bold text-lg">${p.score || 0} pts</span>
                    </div>`).join('');
            });
        }

        function showFeedback(msg, type, detail) {
            const toast = document.getElementById('feedback-toast');
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-sm p-5 rounded-3xl shadow-2xl text-center z-[100] transform transition-all ${type === 'success' ? 'bg-green-500 text-white' : 'bg-orange-500 text-white'}`;
            document.getElementById('feedback-text').innerText = msg;
            document.getElementById('transcript-text').innerText = detail;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function playSuccessSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(523, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1046, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.05);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
            osc.start(); osc.stop(ctx.currentTime + 0.3);
        }

        window.toggleLeaderboard = (show) => { document.getElementById('leaderboard-modal').classList.toggle('hidden', !show); };
        init();
    </script>
</body>
</html>